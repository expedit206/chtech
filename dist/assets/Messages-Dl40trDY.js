import{d as pe,r as x,u as he,a as de,b as ye,c as ie,_ as F,o,e as a,f as xe,g as Y,w as q,n as P,h as t,i as b,F as U,j as V,k as N,l as Z,t as S,m as J,T as ee,p as te,q as be,s as Ie,v as H,x as p,y as we,z as fe,A as _e,B as me,C as Te}from"./index-DwhZS6vE.js";const je=pe("badge",()=>{const i=x({messages:0});return{badgeCounts:i,fetchBadgeCounts:async()=>{},markAsRead:async()=>{},incrementLocalCount:()=>{i.value.messages++},decrementLocalCount:()=>{i.value.messages>0&&i.value.messages--},syncWithBackend:async()=>{}}}),De=pe("message",()=>{const i=he(),y=de(),h=x([]),d=x([]),e=x(null),r=x(!1),$=x(!1),R=x(0),D=x(!0),E=x(window.innerWidth<768),_=x(null),C=x({isTyping:!1,userId:null}),g=x({isRecording:!1,isPaused:!1,recordingTime:0,audioChunks:[],mediaRecorder:null}),u=x(""),n=ye(),k=je(),I=ie(()=>{const s=[];let v="";return d.value.forEach(f=>{const m=new Date(f.created_at).toLocaleDateString();m!==v?(s.push({date:m,messages:[f]}),v=m):s[s.length-1].messages.push(f)}),s}),l=ie(()=>h.value.reduce((s,v)=>s+v.unread_count,0)),O=ie(()=>{const s=window.location.hostname;return s==="localhost"||s==="127.0.0.1"?"http://localhost:8000/storage/":"https://api.espacecameroun.com/storage/"}),A=async()=>{r.value=!0;try{await new Promise(f=>setTimeout(f,800));const s=Array.from({length:15},(f,m)=>{const T=m+2;return{user_id:T.toString(),name:`Utilisateur ${T}`,profile_photo:`https://i.pravatar.cc/150?u=${T}`,last_message:m%2===0?"Bonjour, cet article est-il toujours disponible ?":"D'accord, je vous remercie.",last_message_type:"text",unread_count:m<3?m+1:0,updated_at:new Date(Date.now()-m*1e3*60*60*2).toISOString(),is_online:m%3===0}});h.value=s;const v=h.value.reduce((f,m)=>f+m.unread_count,0);k.badgeCounts&&(k.badgeCounts.messages=v)}catch(s){console.error("Erreur mock conversations",s),y.error("Erreur lors du chargement des conversations simulées")}finally{r.value=!1}},se=async(s,v=!0)=>{if(!(r.value&&!v)){r.value=!0;try{v&&(R.value=0,d.value=[]),await new Promise(T=>setTimeout(T,600));const f=Array.from({length:20},(T,j)=>{var M,z;const B=j%2===0;return{id:j+R.value+100,sender_id:B?(M=n.user)==null?void 0:M.id:Number(s),receiver_id:B?Number(s):(z=n.user)==null?void 0:z.id,content:B?`Ceci est mon message ${j+1} à l'utilisateur ${s}.`:`Voici une réponse simulée ${j+1} de l'utilisateur ${s}.`,type:j===5?"image":"text",is_read:!0,created_at:new Date(Date.now()-(20-j)*1e3*60*10).toISOString(),updated_at:new Date(Date.now()-(20-j)*1e3*60*10).toISOString(),attachment_url:j===5?`https://picsum.photos/300/200?random=${j}`:null,product:j===0?{id:101,nom:"Produit Intéressant",photo_url:"https://via.placeholder.com/50"}:null}});v?d.value=f:d.value=[...f,...d.value],$.value=!1;const m=h.value.find(T=>T.user_id==s);m?e.value=m:e.value={user_id:s,name:`Utilisateur ${s}`,profile_photo:`https://i.pravatar.cc/150?u=${s}`,updated_at:new Date().toISOString(),unread_count:0},m&&(m.unread_count=0)}catch(f){console.error("Erreur mock messages",f),y.error("Erreur lors du chargement des messages simulés")}finally{r.value=!1}}},G=async(s,v="text",f)=>{var j,B;if(!e.value){y.error("Aucune conversation sélectionnée");return}const m=-Date.now(),T={id:m,sender_id:(j=n.user)==null?void 0:j.id,receiver_id:e.value.user_id,content:s,type:v,is_read:!1,product_id:((B=_.value)==null?void 0:B.id)||null,audio_url:v==="audio"?s:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),isTemporary:!0,sender:{...n.user,id:n.user.id,parrain_id:n.user.parrain_id?String(n.user.parrain_id):void 0},receiver:{id:e.value.user_id,nom:e.value.name,email:"",telephone:null,ville:null,premium:!1,parrain_id:void 0},product:_.value};d.value.push(T),u.value="";try{await new Promise(X=>setTimeout(X,500));const M={...T,id:Math.abs(m)+1e3,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),content:s,attachment_url:(v==="image"||v==="video"||v==="audio")&&f?URL.createObjectURL(f):null,isTemporary:!1},z=d.value.findIndex(X=>X.id===m);z!==-1&&(d.value[z]={...M}),Q(M),_.value&&K(),M.isTemporary||setTimeout(()=>{e.value&&e.value.user_id===M.receiver_id&&(C.value={isTyping:!0,userId:M.receiver_id}),setTimeout(()=>{C.value={isTyping:!1,userId:null};const ge={id:Date.now(),sender_id:M.receiver_id,receiver_id:M.sender_id,content:`Ceci est une réponse automatique de ${e.value?e.value.name:"l'utilisateur"}.`,type:"text",is_read:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),sender:M.receiver,receiver:M.sender,product:null};d.value.push(ge),Q(ge)},2e3)},1e3)}catch(M){throw d.value=d.value.filter(z=>z.id!==m),y.error("Erreur lors de l'envoi du message"),M}},oe=async()=>{var s;if(!((s=navigator.mediaDevices)!=null&&s.getUserMedia)){y.error("Enregistrement audio non supporté");return}try{const v=await navigator.mediaDevices.getUserMedia({audio:!0}),f=new MediaRecorder(v);g.value={isRecording:!0,isPaused:!1,recordingTime:0,audioChunks:[],mediaRecorder:f},f.ondataavailable=m=>{m.data.size>0&&g.value.audioChunks.push(m.data)},f.onstop=async()=>{const m=new Blob(g.value.audioChunks,{type:"audio/webm"});await G(URL.createObjectURL(m),"audio",m),v.getTracks().forEach(T=>T.stop())},f.start(),ue()}catch(v){throw y.error("Erreur d'accès au microphone"),v}},W=()=>{g.value.mediaRecorder&&g.value.isRecording&&(g.value.mediaRecorder.stop(),g.value.isRecording=!1,le())},re=()=>{g.value.mediaRecorder&&(g.value.isPaused?(g.value.mediaRecorder.resume(),g.value.isPaused=!1,ue()):(g.value.mediaRecorder.pause(),g.value.isPaused=!0,le()))},ne=()=>{g.value.mediaRecorder&&g.value.isRecording&&(g.value.mediaRecorder.stop(),g.value.isRecording=!1,g.value.isPaused=!1,le())},ae=async s=>{try{const v=h.value.findIndex(f=>f.user_id===String(s));v!==-1&&(h.value[v].unread_count=0),k.decrementLocalCount&&k.decrementLocalCount("messages")}catch(v){console.error("Erreur simulation markAllRead",v)}},w=async(s,v)=>{try{const f=d.value.findIndex(m=>m.id===s);f!==-1&&(d.value[f].content=v,d.value[f].updated_at=new Date().toISOString()),e.value&&f===d.value.length-1&&Q(d.value[f])}catch(f){throw y.error("Erreur lors de la modification du message"),f}},c=async s=>{try{if(d.value=d.value.filter(v=>v.id!==s),e.value&&d.value.length>0)Q(d.value[d.value.length-1]);else if(d.value.length===0&&e.value){const v=h.value.findIndex(f=>f.user_id===e.value.user_id);v!==-1&&(h.value[v].last_message="",h.value[v].last_message_type="text")}}catch(v){throw y.error("Erreur lors de la suppression du message"),v}},L=s=>{_.value=s,localStorage.setItem("chatProduct",JSON.stringify(s))},K=()=>{_.value=null,localStorage.removeItem("chatProduct")},ce=()=>{D.value=!D.value},Ce=s=>{i.push({name:"messages",params:{receiverId:s}}),E.value&&(D.value=!1)},ue=()=>{g.value.recordingTime=0;const s=setInterval(()=>{g.value.isPaused||g.value.recordingTime++},1e3);g.value.timer=s},le=()=>{g.value.timer&&clearInterval(g.value.timer)},Q=s=>{var f;const v=h.value.findIndex(m=>m.user_id===s.sender_id||m.user_id===s.receiver_id);v!==-1&&(h.value[v].last_message=s.type==="audio"?"Message vocal":s.type==="image"?"Photo":s.type==="video"?"Vidéo":s.content,h.value[v].last_message_type=s.type,h.value[v].updated_at=s.updated_at,s.receiver_id===((f=n.user)==null?void 0:f.id)&&!s.is_read&&(h.value[v].unread_count+=1))},Se=()=>{var s;(s=n.user)!=null&&s.id},$e=()=>{},Me=()=>{},Re=()=>{const s=localStorage.getItem("chatProduct");s&&(_.value=JSON.parse(s)),window.addEventListener("resize",ve),k.fetchBadgeCounts().catch(console.error)},ve=()=>{E.value=window.innerWidth<768,D.value=window.innerWidth>=768};return{conversations:h,messages:d,selectedConversation:e,isLoading:r,hasMore:$,isSidebarOpen:D,isMobile:E,product:_,typingState:C,recordingState:g,newMessage:u,groupedMessages:I,unreadCount:l,storageUrl:O,fetchConversations:A,fetchMessages:se,sendMessage:G,startRecording:oe,stopRecording:W,toggleRecordingPause:re,cancelRecording:ne,markAllMessagesAsRead:ae,editMessage:w,deleteMessage:c,setProductTag:L,clearProductTag:K,toggleSidebar:ce,selectConversation:Ce,subscribeToChannel:Se,unsubscribeFromChannel:$e,emitTyping:Me,initialize:Re,cleanup:()=>{window.removeEventListener("resize",ve)}}});function ke(){return{t:y=>({messages_seo_title:"Messages",messages_seo_description:"Vos conversations",messages_seo_keywords:"chat, messages, conversation",messages_structured_name:"Messagerie",messages_structured_description:"Interface de messagerie",select_conversation_to_start:"Sélectionnez une conversation pour commencer",edit:"Modifier",delete:"Supprimer"})[y]||y}}const Le={},Pe={class:"p-3 rounded-xl flex items-center gap-3 animate-pulse"};function Ee(i,y){return o(),a("div",Pe,[...y[0]||(y[0]=[xe('<div class="w-12 h-12 rounded-full bg-gray-200 flex-shrink-0"></div><div class="flex-1 min-w-0 space-y-2"><div class="flex justify-between"><div class="h-4 bg-gray-200 rounded w-1/2"></div><div class="h-3 bg-gray-200 rounded w-12"></div></div><div class="h-3 bg-gray-200 rounded w-3/4"></div></div>',2)])])}const Ue=F(Le,[["render",Ee]]),Oe={class:"p-4 border-b flex items-center justify-between sticky top-0 z-10",style:{backgroundColor:"var(--color-surface)",borderColor:"var(--color-border)"}},Ae={class:"flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1"},ze={key:0,class:"space-y-2"},Be={key:1,class:"flex flex-col items-center justify-center h-48 text-gray-400"},Ve=["onClick"],Ne={key:0,class:"absolute left-0 top-1/2 -translate-y-1/2 h-8 w-1 bg-[var(--color-primary)] rounded-r-full"},Fe=["onClick"],We={class:"w-12 h-12 rounded-full overflow-hidden ring-2 ring-transparent group-hover:ring-gray-100 transition-all",style:{backgroundColor:"var(--color-bg)"}},Ke=["src"],He={key:1,class:"w-full h-full flex items-center justify-center bg-[var(--color-primary)] text-white text-lg font-bold"},qe={class:"flex-1 min-w-0"},Je={class:"flex justify-between items-baseline mb-0.5"},Ge={class:"text-[10px] font-medium whitespace-nowrap",style:{color:"var(--color-text-sub)"}},Qe={class:"flex items-center justify-between"},Xe={class:"flex items-center gap-1.5 min-w-0 text-sm",style:{color:"var(--color-text-sub)"}},Ye={key:0,class:"fas fa-camera text-sm"},Ze={key:1,class:"fas fa-video text-sm"},et={key:2,class:"fas fa-microphone text-sm"},tt={key:0,class:"ml-2 bg-[var(--color-primary)] text-white text-[10px] font-bold h-5 min-w-[20px] px-1.5 rounded-full flex items-center justify-center shadow-sm"},st={__name:"Sidebar",props:{conversations:Array,isSidebarOpen:Boolean,isMobile:Boolean,storageUrl:String,activeConversationId:[String,Number],isLoading:Boolean},emits:["select-conversation","toggle-sidebar","view-profile"],setup(i,{emit:y}){const h=d=>{if(!d)return"";const e=new Date(d),r=new Date;return e.toDateString()===r.toDateString()?e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):Math.ceil((r.getTime()-e.getTime())/(1e3*60*60*24))<7?e.toLocaleDateString([],{weekday:"short"}):e.toLocaleDateString([],{month:"short",day:"numeric"})};return(d,e)=>(o(),Y(ee,{name:"slide-fade"},{default:q(()=>[i.isSidebarOpen||!i.isMobile?(o(),a("div",{key:0,class:P(["border-r flex flex-col h-full transition-all duration-300 z-20",i.isMobile?"fixed inset-0 w-full":"w-80 md:w-96"]),style:{backgroundColor:"var(--color-surface)",borderColor:"var(--color-border)"}},[t("div",Oe,[e[2]||(e[2]=t("h2",{class:"text-xl font-bold",style:{color:"var(--color-text-main)"}}," Messages ",-1)),i.isMobile?(o(),a("button",{key:0,onClick:e[0]||(e[0]=r=>d.$emit("toggle-sidebar")),class:"w-8 h-8 rounded-full flex items-center justify-center transition-colors",style:{backgroundColor:"var(--color-bg)",color:"var(--color-text-sub)"}},[...e[1]||(e[1]=[t("i",{class:"fas fa-times"},null,-1)])])):b("",!0)]),t("div",Ae,[i.isLoading?(o(),a("div",ze,[(o(),a(U,null,V(8,r=>N(Ue,{key:r})),64))])):i.conversations.length===0?(o(),a("div",Be,[...e[3]||(e[3]=[t("i",{class:"far fa-comments text-4xl mb-2 opacity-50"},null,-1),t("p",{class:"text-sm"},"Aucune conversation",-1)])])):(o(!0),a(U,{key:2},V(i.conversations,r=>(o(),a("div",{key:r.user_id,onClick:$=>d.$emit("select-conversation",r.user_id),class:P(["group p-3 rounded-xl cursor-pointer transition-all duration-200 flex items-center gap-3 relative overflow-hidden",[i.activeConversationId==r.user_id?"bg-(--color-primary)/10":"hover:bg-(--color-primary)/10"]])},[i.activeConversationId==r.user_id?(o(),a("div",Ne)):b("",!0),t("div",{class:"relative flex-shrink-0",onClick:Z($=>d.$emit("view-profile",r.user_id),["stop"])},[t("div",We,[r.profile_photo?(o(),a("img",{key:0,src:String(r.profile_photo).startsWith("http")?r.profile_photo:i.storageUrl+r.profile_photo,alt:"",class:"w-full h-full object-cover"},null,8,Ke)):(o(),a("div",He,S(r.name.charAt(0).toUpperCase()),1))])],8,Fe),t("div",qe,[t("div",Je,[t("h3",{class:P(["font-semibold truncate pr-2",{"text-[var(--color-primary)]":i.activeConversationId==r.user_id}]),style:J({color:i.activeConversationId!=r.user_id?"var(--color-text-main)":""})},S(r.name),7),t("span",Ge,S(h(r.updated_at)),1)]),t("div",Qe,[t("div",Xe,[r.last_message_type==="image"?(o(),a("i",Ye)):r.last_message_type==="video"?(o(),a("i",Ze)):r.last_message_type==="audio"?(o(),a("i",et)):b("",!0),t("span",{class:P(["truncate block",{"font-medium":r.unread_count>0}]),style:J({color:r.unread_count>0?"var(--color-text-main)":"var(--color-text-sub)"})},S(r.last_message||(r.last_message_type==="image"?"Photo":r.last_message_type==="video"?"Vidéo":r.last_message_type==="audio"?"Message vocal":"Message")),7)]),r.unread_count>0?(o(),a("div",tt,S(r.unread_count),1)):b("",!0)])])],10,Ve))),128))])],2)):b("",!0)]),_:1}))}},ot=F(st,[["__scopeId","data-v-635f6e69"]]),rt={},nt={class:"flex flex-col space-y-4 p-4 w-full"};function at(i,y){return o(),a("div",nt,[...y[0]||(y[0]=[xe('<div class="flex justify-start w-full animate-pulse"><div class="bg-gray-200 rounded-2xl rounded-tl-none px-4 py-3 min-w-[150px] max-w-[70%] h-16"></div></div><div class="flex justify-end w-full animate-pulse"><div class="bg-gray-200 rounded-2xl rounded-tr-none px-4 py-3 min-w-[150px] max-w-[70%] h-12"></div></div><div class="flex justify-start w-full animate-pulse"><div class="bg-gray-200 rounded-2xl rounded-tl-none px-4 py-3 min-w-[200px] max-w-[70%] h-24"></div></div><div class="flex justify-end w-full animate-pulse"><div class="bg-gray-200 rounded-2xl rounded-tr-none px-4 py-3 min-w-[100px] max-w-[70%] h-10"></div></div>',4)])])}const lt=F(rt,[["render",at]]),it={class:"h-full flex flex-col relative overflow-hidden",style:{backgroundColor:"var(--color-bg)"}},dt={key:0,class:"flex flex-col space-y-4 py-4"},ct={class:"flex justify-center sticky top-0 z-10 py-2"},ut={class:"backdrop-blur-sm text-[11px] font-bold px-3 py-1 rounded-full shadow-sm border uppercase tracking-wide",style:{backgroundColor:"var(--color-surface)",borderColor:"var(--color-border)",color:"var(--color-text-sub)"}},vt=["onClick"],gt=["src"],ft=["src"],mt=["src"],pt={key:4,class:"whitespace-pre-wrap text-[15px] leading-relaxed block"},ht={key:0},yt={key:0,class:"fas fa-check-double text-blue-500"},xt={key:1,class:"fas fa-check"},bt=["onClick"],wt={key:0,class:"absolute right-0 top-full mt-1 w-32 bg-white rounded-lg shadow-xl border border-gray-100 z-50 overflow-hidden text-sm animate-in fade-in zoom-in-95 duration-100"},_t=["onClick"],kt=["onClick"],Ct={key:1,class:"flex items-end gap-2 text-gray-400 text-sm ml-2 animate-bounce"},St={__name:"Content",props:{messages:Array,isLoading:Boolean,typingUser:Boolean,selectedConversation:Object,authStore:Object},emits:["mounted","edit-message","delete-message"],setup(i,{emit:y}){const{t:h}=ke(),d=i,e=x(null),r=x(null),$=de(),R=y,D=u=>{e.value=e.value===u?null:u};document.addEventListener("click",()=>e.value=null);const E=()=>{we(()=>{r.value&&(r.value.scrollTop=r.value.scrollHeight)})};te(()=>d.messages,()=>{E()},{deep:!0}),be(()=>{E()});const _=u=>{if(u.isTemporary){$.error("Message en cours d'envoi");return}const n=prompt("Modifier le message :",u.content);n&&n.trim()!==u.content&&fe.put(`/chat/message/${u.id}`,{content:n.trim()}).then(()=>{R("edit-message",{id:u.id,content:n.trim()})}).catch(()=>$.error("Échec de la modification du message"))},C=u=>{const n=d.messages.flatMap(k=>k.messages).find(k=>k.id===u);if(n!=null&&n.isTemporary){$.error("Message en cours d’envoi");return}confirm("Voulez-vous vraiment supprimer ce message ?")&&fe.delete(`/chat/message/${u}`).then(()=>R("delete-message",u)).catch(()=>$.error("Échec de la suppression du message"))},g=u=>{window.open(u,"_blank")};return(u,n)=>{const k=Ie("router-link");return o(),a("div",it,[t("div",{class:"flex-1 overflow-y-auto p-4 space-y-6 z-0",ref_key:"messagesContainer",ref:r,style:{"scroll-behavior":"smooth"}},[i.isLoading?(o(),a("div",dt,[(o(),a(U,null,V(3,I=>N(lt,{key:I})),64))])):b("",!0),(o(!0),a(U,null,V(i.messages,I=>(o(),a("div",{key:I.date,class:"space-y-4"},[t("div",ct,[t("span",ut,S(I.date),1)]),(o(!0),a(U,null,V(I.messages,l=>{var O;return o(),a("div",{key:l.id,class:P(["group flex w-full mb-1",l.sender_id===i.authStore.user.id?"justify-end":"justify-start"])},[t("div",{class:P(["relative max-w-[85%] sm:max-w-[70%] flex flex-col",l.sender_id===i.authStore.user.id?"items-end":"items-start"])},[t("div",{class:P(["relative shadow-sm break-words overflow-hidden transition-all",[l.type==="text"||l.type==="audio"||l.attachment_url&&l.content?l.sender_id===i.authStore.user.id?"rounded-2xl rounded-tr-none px-4 py-3 text-white":"rounded-2xl rounded-tl-none px-4 py-3 border":"rounded-2xl p-0 bg-transparent shadow-none"]]),style:J(l.type==="text"||l.type==="audio"||l.attachment_url&&l.content?l.sender_id===i.authStore.user.id?{backgroundColor:"var(--color-primary)"}:{backgroundColor:"var(--color-surface)",borderColor:"var(--color-border)",color:"var(--color-text-main)"}:{})},[(O=l.product)!=null&&O.id?(o(),Y(k,{key:0,to:{name:"DetailProduit",params:{id:l.product.id}},class:P(["flex items-center gap-2 mb-2 bg-black/10 p-2 rounded-lg hover:bg-black/20 transition text-sm font-medium",l.sender_id===i.authStore.user.id?"text-white":"text-blue-600"])},{default:q(()=>[n[0]||(n[0]=t("i",{class:"fas fa-tag"},null,-1)),H(" Produit: "+S(l.product.nom),1)]),_:2},1032,["to","class"])):b("",!0),l.type==="image"?(o(),a("div",{key:1,class:P(["overflow-hidden cursor-pointer mb-1",l.content?"rounded-lg mb-2":"rounded-2xl"]),onClick:A=>g(l.attachment_url||l.content)},[t("img",{src:l.attachment_url||l.content,class:"max-w-full h-auto max-h-80 object-cover min-w-[200px]",loading:"lazy"},null,8,gt)],10,vt)):b("",!0),l.type==="video"?(o(),a("video",{key:2,controls:"",class:P(["max-w-sm max-h-80 bg-black mb-1",l.content?"rounded-lg mb-2":"rounded-2xl"]),preload:"metadata"},[t("source",{src:l.attachment_url||l.content,type:"video/mp4"},null,8,ft),n[1]||(n[1]=H(" Votre navigateur ne supporte pas la vidéo. ",-1))],2)):b("",!0),l.type==="audio"?(o(),a("audio",{key:3,controls:"",class:P(["max-w-[240px]",l.sender_id===i.authStore.user.id?"opacity-90 grayscale contrast-200":""])},[t("source",{src:l.attachment_url||l.content,type:"audio/webm"},null,8,mt),n[2]||(n[2]=H(" Audio error ",-1))],2)):b("",!0),l.type==="text"||l.attachment_url&&l.content?(o(),a("p",pt,S(l.content),1)):b("",!0)],6),t("div",{class:P(["flex items-center gap-1 mt-1 px-1 select-none opacity-60 text-[10px] font-medium",[l.sender_id===i.authStore.user.id?"justify-end text-gray-500":"justify-start text-gray-400"]])},[t("span",null,S(new Date(l.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),1),l.sender_id===i.authStore.user.id?(o(),a("span",ht,[l.is_read?(o(),a("i",yt)):(o(),a("i",xt))])):b("",!0)],2),l.sender_id===i.authStore.user.id?(o(),a("button",{key:0,onClick:Z(A=>D(l.id),["stop"]),class:"absolute top-0 -left-8 opacity-0 group-hover:opacity-100 transition-opacity p-2 text-gray-400 hover:text-gray-600"},[...n[3]||(n[3]=[t("i",{class:"fas fa-ellipsis-v text-sm"},null,-1)])],8,bt)):b("",!0),N(ee,{name:"fade"},{default:q(()=>[e.value===l.id?(o(),a("div",wt,[l.type==="text"?(o(),a("button",{key:0,onClick:A=>_(l),class:"flex items-center gap-2 w-full px-4 py-2 text-left hover:bg-gray-50 text-gray-700"},[n[4]||(n[4]=t("i",{class:"fas fa-pen text-sm w-4"},null,-1)),H(" "+S(p(h)("edit")),1)],8,_t)):b("",!0),t("button",{onClick:A=>C(l.id),class:"flex items-center gap-2 w-full px-4 py-2 text-left hover:bg-red-50 text-red-600"},[n[5]||(n[5]=t("i",{class:"fas fa-trash text-sm w-4"},null,-1)),H(" "+S(p(h)("delete")),1)],8,kt)])):b("",!0)]),_:2},1024)],2)],2)}),128))]))),128)),i.typingUser?(o(),a("div",Ct,[...n[6]||(n[6]=[t("div",{class:"w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center"},[t("i",{class:"fas fa-ellipsis-h text-gray-400"})],-1),t("span",null,"En train d'écrire...",-1)])])):b("",!0),n[7]||(n[7]=t("div",{class:"h-4"},null,-1))],512)])}}},$t=F(St,[["__scopeId","data-v-c1900c67"]]),Mt={class:"px-4 py-3 border-t",style:{backgroundColor:"var(--color-surface)",borderColor:"var(--color-border)"}},Rt={class:"max-w-4xl mx-auto flex items-end gap-2 relative"},It={key:0,class:"absolute -top-12 left-0 shadow-lg border rounded-lg p-2 flex items-center gap-3 z-10 text-sm",style:{backgroundColor:"var(--color-surface)",borderColor:"var(--color-border)",color:"var(--color-text-main)"}},Tt={class:"w-8 h-8 rounded overflow-hidden",style:{backgroundColor:"var(--color-bg)"}},jt=["src"],Dt={key:1,class:"fas fa-box text-gray-400 m-auto"},Lt={class:"font-medium text-gray-700 truncate max-w-[150px]"},Pt={key:0,class:"absolute bottom-full left-0 w-full mb-2 rounded-lg shadow-xl border p-3 z-20",style:{backgroundColor:"var(--color-surface)",borderColor:"var(--color-border)"}},Et={class:"flex flex-col gap-3"},Ut={class:"relative w-full rounded-lg overflow-hidden max-h-60 flex items-center justify-center",style:{backgroundColor:"var(--color-bg)"}},Ot=["src"],At=["src"],zt={class:"flex items-center gap-2"},Bt=["value","onKeydown"],Vt={key:0,class:"flex items-center gap-1 pb-2"},Nt={class:"flex-1 rounded-[1.5rem] flex items-center min-h-[48px] px-2 transition-colors focus-within:ring-1 focus-within:ring-gray-300 focus-within:shadow-sm",style:{backgroundColor:"var(--color-bg)"}},Ft=["value"],Wt={key:1,class:"flex-1 flex items-center gap-3 px-2"},Kt={class:"text-sm font-mono text-gray-500 min-w-[45px]"},Ht={class:"flex-1 flex items-center gap-1 h-6 justify-center opacity-50"},qt={class:"flex items-center pr-1 gap-1"},Jt={__name:"Input",props:{newMessage:String,isRecording:Boolean,product:Object},emits:["update:newMessage","send-message","send-image","send-video","start-recording","stop-recording","emit-typing","clear-product-tag","pause-recording","resume-recording"],setup(i,{emit:y}){const h=i,d=y,e=x(0),r=x(null),$=x(!1),R=x(null),D=x(null),E=x(null),_=x(null),C=x(null),g=x("");te(()=>h.newMessage,()=>{we(()=>{R.value&&(R.value.style.height="auto",R.value.style.height=Math.min(R.value.scrollHeight,128)+"px")})});const u=()=>{var w;(w=D.value)==null||w.click()},n=()=>{var w;(w=E.value)==null||w.click()},k=w=>{const c=w.target;c.files&&c.files[0]&&(_.value=c.files[0],C.value="image",g.value=URL.createObjectURL(c.files[0]),c.value="")},I=w=>{const c=w.target;c.files&&c.files[0]&&(_.value=c.files[0],C.value="video",g.value=URL.createObjectURL(c.files[0]),c.value="")},l=()=>{_.value&&C.value&&(C.value==="image"?d("send-image",_.value,h.newMessage):d("send-video",_.value,h.newMessage),O(),d("update:newMessage",""))},O=()=>{g.value&&URL.revokeObjectURL(g.value),_.value=null,C.value=null,g.value=""},A=()=>{d("start-recording"),$.value=!1,e.value=0,oe()},se=()=>{d("stop-recording"),W()},G=()=>{d("stop-recording"),W()},oe=()=>{r.value&&clearInterval(r.value),r.value=window.setInterval(()=>{e.value++},1e3)},W=()=>{r.value&&(clearInterval(r.value),r.value=null)},re=w=>{const c=Math.floor(w/60),L=w%60;return`${c.toString().padStart(2,"0")}:${L.toString().padStart(2,"0")}`},ne=w=>{const c=w.target;d("update:newMessage",c.value),d("emit-typing")},ae=w=>h.isRecording?4+Math.random()*16+"px":"4px";return _e(()=>{W()}),(w,c)=>(o(),a("div",Mt,[t("div",Rt,[N(ee,{name:"slide-up"},{default:q(()=>{var L,K;return[(L=i.product)!=null&&L.id?(o(),a("div",It,[t("div",Tt,[i.product.photo_url?(o(),a("img",{key:0,src:i.product.photo_url,class:"w-full h-full object-cover"},null,8,jt)):(o(),a("i",Dt))]),t("span",Lt,S((K=i.product)==null?void 0:K.nom),1),t("button",{onClick:c[0]||(c[0]=ce=>w.$emit("clear-product-tag")),class:"w-5 h-5 flex items-center justify-center rounded-full hover:bg-red-50 text-gray-400 hover:text-red-500 transition-colors"},[...c[4]||(c[4]=[t("i",{class:"fas fa-times text-sm"},null,-1)])])])):b("",!0)]}),_:1}),N(ee,{name:"slide-up"},{default:q(()=>[_.value?(o(),a("div",Pt,[t("div",Et,[t("div",Ut,[C.value==="image"?(o(),a("img",{key:0,src:g.value,class:"max-w-full max-h-60 object-contain"},null,8,Ot)):C.value==="video"?(o(),a("video",{key:1,src:g.value,controls:"",class:"max-w-full max-h-60"},null,8,At)):b("",!0),t("button",{onClick:O,class:"absolute top-2 right-2 w-8 h-8 bg-black/50 text-white rounded-full flex items-center justify-center hover:bg-black/70"},[...c[5]||(c[5]=[t("i",{class:"fas fa-times"},null,-1)])])]),t("div",zt,[t("input",{value:i.newMessage,onInput:c[1]||(c[1]=L=>w.$emit("update:newMessage",L.target.value)),type:"text",placeholder:"Ajouter une légende...",onKeydown:me(Z(l,["prevent"]),["enter"]),class:"flex-1 border rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[var(--color-primary)]",style:{backgroundColor:"var(--color-bg)",borderColor:"var(--color-border)",color:"var(--color-text-main)"}},null,40,Bt),t("button",{onClick:l,class:"w-10 h-10 bg-[var(--color-primary)] text-white rounded-full flex items-center justify-center hover:bg-green-800 shadow-sm"},[...c[6]||(c[6]=[t("i",{class:"fas fa-paper-plane"},null,-1)])])])])])):b("",!0)]),_:1}),!i.isRecording&&!_.value?(o(),a("div",Vt,[t("button",{onClick:u,class:"w-9 h-9 rounded-full text-gray-400 hover:text-[var(--color-primary)] hover:bg-green-50 flex items-center justify-center transition-all",title:"Envoyer une image"},[...c[7]||(c[7]=[t("i",{class:"far fa-image text-lg"},null,-1)])]),t("button",{onClick:n,class:"w-9 h-9 rounded-full text-gray-400 hover:text-blue-500 hover:bg-blue-50 flex items-center justify-center transition-all",title:"Envoyer une vidéo"},[...c[8]||(c[8]=[t("i",{class:"fas fa-video text-lg"},null,-1)])]),t("input",{type:"file",ref_key:"fileInput",ref:D,accept:"image/*",class:"hidden",onChange:k},null,544),t("input",{type:"file",ref_key:"videoInput",ref:E,accept:"video/*",class:"hidden",onChange:I},null,544)])):b("",!0),t("div",Nt,[i.isRecording?(o(),a("div",Wt,[c[9]||(c[9]=t("div",{class:"w-2 h-2 rounded-full bg-red-500 animate-pulse"},null,-1)),t("span",Kt,S(re(e.value)),1),t("div",Ht,[(o(),a(U,null,V(12,L=>t("div",{key:L,class:"w-1 bg-[var(--color-primary)] rounded-full transition-all duration-75",style:J({height:ae()})},null,4)),64))])])):(o(),a("textarea",{key:0,value:i.newMessage,onInput:ne,onKeydown:c[2]||(c[2]=me(Z(L=>w.$emit("send-message"),["prevent"]),["enter"])),rows:"1",placeholder:"Message...",class:"w-full bg-transparent border-none focus:ring-0 px-4 py-3 placeholder-gray-400 resize-none max-h-32 overflow-y-auto",style:J([{color:"var(--color-text-main)"},{"min-height":"48px","box-shadow":"none !important"}]),ref_key:"textAreaRef",ref:R},null,40,Ft)),t("div",qt,[i.isRecording?(o(),a(U,{key:0},[t("button",{onClick:G,class:"w-8 h-8 rounded-full text-red-400 hover:text-red-500 hover:bg-red-50 flex items-center justify-center transition-all",title:"Annuler"},[...c[10]||(c[10]=[t("i",{class:"fas fa-trash-alt text-sm"},null,-1)])]),t("button",{onClick:se,class:"w-8 h-8 rounded-full bg-[var(--color-primary)] text-white hover:bg-green-800 flex items-center justify-center shadow-md transform hover:scale-105 transition-all",title:"Envoyer"},[...c[11]||(c[11]=[t("i",{class:"fas fa-arrow-up"},null,-1)])])],64)):(o(),a(U,{key:1},[i.newMessage.trim()?(o(),a("button",{key:1,onClick:c[3]||(c[3]=L=>w.$emit("send-message")),class:"w-8 h-8 rounded-full bg-[var(--color-primary)] text-white hover:bg-green-800 flex items-center justify-center shadow-md transform hover:scale-105 transition-all",title:"Envoyer"},[...c[13]||(c[13]=[t("i",{class:"fas fa-arrow-up"},null,-1)])])):(o(),a("button",{key:0,onClick:A,class:"w-8 h-8 rounded-full text-gray-400 hover:text-red-500 hover:bg-red-50 flex items-center justify-center transition-all",title:"Message vocal"},[...c[12]||(c[12]=[t("i",{class:"fas fa-microphone text-lg"},null,-1)])]))],64))])])])]))}},Gt=F(Jt,[["__scopeId","data-v-b9191692"]]),Qt={class:"w-full flex relative h-[calc(100vh-64px)] min-h-[500px]"},Xt={class:"h-full w-full flex flex-col",style:{backgroundColor:"var(--color-bg)"}},Yt={class:"flex border-b items-center px-4 flex-shrink-0 min-h-[60px]",style:{backgroundColor:"var(--color-surface)",borderColor:"var(--color-border)"}},Zt={key:1,class:"text-xl font-semibold p-4 flex items-center",style:{color:"var(--color-text-main)"}},es={class:"shadow-md transition-all duration-300 flex flex-col flex-1 h-full overflow-hidden w-full relative",style:{backgroundColor:"var(--color-bg)"}},ts={key:1,class:"flex items-center justify-center h-full"},ss={class:"text-lg",style:{color:"var(--color-text-sub)"}},os={__name:"Messages",setup(i){const{t:y}=ke();he();const h=Te(),d=ye(),e=De();de();const r=x(!1),$=u=>{e.selectConversation(u)},R=()=>{e.newMessage.trim()!==""&&e.sendMessage(e.newMessage,"text")},D=(u,n)=>{e.sendMessage(n,"image",u)},E=(u,n)=>{e.sendMessage(n,"video",u)},_=({id:u,content:n})=>{e.editMessage(u,n)},C=u=>{e.deleteMessage(u)},g=u=>{console.log("View profile",u)};return be(async()=>{var u;e.initialize();try{r.value=!0,await e.fetchConversations()}catch(n){console.error(n)}finally{r.value=!1}try{h.params.receiverId&&await e.fetchMessages(h.params.receiverId),(u=d.user)!=null&&u.id&&e.subscribeToChannel()}catch(n){console.error(n)}}),_e(()=>{e.cleanup()}),te(()=>h.params.receiverId,async u=>{u&&await e.fetchMessages(u)}),te(()=>{var u;return(u=d.user)==null?void 0:u.id},u=>{u&&e.subscribeToChannel()}),(u,n)=>{var k;return o(),a("div",Qt,[N(ot,{conversations:p(e).conversations,"is-sidebar-open":p(e).isSidebarOpen,"is-mobile":p(e).isMobile,"storage-url":p(e).storageUrl,"is-loading":r.value,onSelectConversation:$,onToggleSidebar:p(e).toggleSidebar,onViewProfile:g,"active-conversation-id":(k=p(e).selectedConversation)==null?void 0:k.user_id},null,8,["conversations","is-sidebar-open","is-mobile","storage-url","is-loading","onToggleSidebar","active-conversation-id"]),t("div",Xt,[t("div",Yt,[!p(e).isSidebarOpen&&p(e).isMobile&&p(e).selectedConversation?(o(),a("button",{key:0,onClick:n[0]||(n[0]=(...I)=>p(e).toggleSidebar&&p(e).toggleSidebar(...I)),class:"p-2 rounded-full hover:bg-gray-100 transition mr-2",style:{color:"var(--color-text-main)"}},[...n[2]||(n[2]=[t("i",{class:"fas fa-arrow-left text-xl"},null,-1)])])):b("",!0),p(e).selectedConversation?(o(),a("h2",Zt,S(p(e).selectedConversation.name),1)):b("",!0)]),t("div",es,[p(e).selectedConversation?(o(),Y($t,{key:0,onEditMessage:_,onDeleteMessage:C,messages:p(e).groupedMessages,"is-loading":p(e).isLoading,"typing-user":p(e).typingState.isTyping,"selected-conversation":p(e).selectedConversation,"auth-store":p(d)},null,8,["messages","is-loading","typing-user","selected-conversation","auth-store"])):(o(),a("div",ts,[t("p",ss,S(p(y)("select_conversation_to_start")),1)])),p(e).selectedConversation?(o(),Y(Gt,{key:2,"new-message":p(e).newMessage,"is-recording":p(e).recordingState.isRecording,product:p(e).product,onSendMessage:R,onSendImage:D,onSendVideo:E,onStartRecording:p(e).startRecording,onStopRecording:p(e).stopRecording,onEmitTyping:p(e).emitTyping,"onUpdate:newMessage":n[1]||(n[1]=I=>p(e).newMessage=I),onPauseRecording:p(e).toggleRecordingPause,onResumeRecording:p(e).toggleRecordingPause,onClearProductTag:p(e).clearProductTag},null,8,["new-message","is-recording","product","onStartRecording","onStopRecording","onEmitTyping","onPauseRecording","onResumeRecording","onClearProductTag"])):b("",!0)])])])}}},is=F(os,[["__scopeId","data-v-55424909"]]);export{is as default};
